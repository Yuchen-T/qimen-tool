<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>å¥‡é—¨éç”²ä¸“ä¸šç‰ˆ - æ°‘ç”¨æ™¨æš®å…‰æ—¶è¾°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- å¼•å…¥ SunCalc åº“ä½œä¸ºå¤‡ç”¨æˆ–è¾…åŠ©ï¼ˆå¦‚æœéœ€è¦æ›´ç²¾ç¡®çš„ç§’çº§è®¡ç®—ï¼‰ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 50%, #e2e8f0 100%);
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }
        .dark body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
        }
        
        /* ä¼˜é›…çš„æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { 
            background: #cbd5e1; 
            border-radius: 4px;
            transition: background 0.3s;
        }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* è¾“å…¥æ¡†èšç„¦åŠ¨æ•ˆ */
        .input-group { transition: transform 0.2s; }
        .input-group:focus-within { transform: translateY(-1px); }

        /* ç»“æœé¢æ¿åŠ¨ç”» */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in { animation: slideIn 0.4s ease-out forwards; }

        /* ç»ç’ƒæ‹Ÿæ€èƒŒæ™¯ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .dark .glass-panel {
            background: rgba(30, 41, 59, 0.98);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 640px) {
            body {
                padding: 0.75rem;
            }
            
            /* é˜²æ­¢ç§»åŠ¨ç«¯è¾“å…¥æ¡†æ”¾å¤§ */
            input, select, textarea {
                font-size: 16px !important;
            }
            
            /* ä¼˜åŒ–æ—¶è¾°æ˜¾ç¤ºåŒºåŸŸ */
            #result-box {
                font-size: 14px;
            }
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a'
                        },
                        mystic: { 800: '#1e293b', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>
    
    <!-- ç«‹å³æ‰§è¡Œä¸»é¢˜åˆå§‹åŒ–ï¼Œé¿å…é—ªçƒ -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</head>
<body class="text-slate-800 dark:text-slate-100 min-h-screen transition-colors duration-300 p-4 sm:p-6 md:p-8">

    <div class="max-w-4xl mx-auto space-y-8">
        
        <!-- é¡¶éƒ¨æ ‡é¢˜ -->
        <header class="text-center space-y-2 pt-4 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-white tracking-tight flex items-center justify-center gap-3">
                <i class="ph-fill ph-yin-yang text-brand-600 dark:text-brand-500"></i>
                <span>å¥‡é—¨éç”²è¾…åŠ©å·¥å…·</span>
            </h1>
            <p class="text-slate-500 dark:text-slate-400 text-sm md:text-base">
                åŸºäºæ°‘ç”¨æ™¨æš®å…‰ (Civil Twilight) çš„çœŸå¤ªé˜³æ—¶å˜åŠ¨æ—¶è¾°è®¡ç®—
            </p>
            
            <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
            <button id="themeToggle" class="absolute top-0 right-0 p-2.5 rounded-xl bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:border-brand-400 dark:hover:border-brand-500 transition-all shadow-sm hover:shadow-md">
                <i class="ph-bold ph-sun text-xl hidden dark:inline"></i>
                <i class="ph-bold ph-moon text-xl inline dark:hidden"></i>
            </button>
        </header>

        <!-- è®¾ç½®åŒºåŸŸ (API Key) - å·²å†…ç½®ï¼Œéšè—æ˜¾ç¤ºä½†ä¿ç•™é€»è¾‘æ¥å£ -->
        <!-- <section class="glass-panel rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 p-4"> ... </section> -->
        
        <!-- ä¸»åŠŸèƒ½åŒºï¼šåŒæ å¸ƒå±€ -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- å·¦ä¾§ï¼šæ—¶è¾°è®¡ç®—å™¨ (å  7 åˆ—) -->
            <div class="lg:col-span-7 space-y-6">
                <section class="glass-panel rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700/50 flex justify-between items-center bg-gradient-to-r from-slate-50 to-white dark:from-slate-800 dark:to-slate-800">
                        <h2 class="text-lg font-bold flex items-center gap-2 text-slate-800 dark:text-white">
                            <i class="ph-duotone ph-clock-afternoon text-brand-500 text-xl"></i>
                            å˜åŠ¨æ—¶è¾°è®¡ç®—å™¨
                        </h2>
                        <span class="text-xs font-semibold px-2.5 py-1 bg-brand-100 dark:bg-brand-900/50 text-brand-700 dark:text-brand-300 rounded-full">æ˜¼ä¸ƒå¤œäº”</span>
                    </div>
                    
                    <div class="p-6 space-y-6">
                        <form id="shichenForm" class="space-y-5">
                            <!-- ç¬¬ä¸€è¡Œï¼šåœ°ç‚¹ (ä¸‰çº§è”åŠ¨) -->
                            <div class="space-y-1.5 input-group">
                                <label class="text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider flex justify-between items-center">
                                    <span>åœ°ç‚¹é€‰æ‹© (ä¸­å›½)</span>
                                    <span id="geo-status" class="text-[11px] font-medium text-slate-500 dark:text-slate-400">ç­‰å¾…é€‰æ‹©...</span>
                                </label>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="relative">
                                        <select id="provinceSelect" class="w-full pl-3 pr-8 py-3 bg-white dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-xl text-sm font-medium text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none appearance-none truncate transition-all hover:border-brand-400">
                                            <option value="">é€‰æ‹©çœä»½</option>
                                        </select>
                                        <i class="ph-bold ph-caret-down absolute right-3 top-3.5 text-slate-400 pointer-events-none"></i>
                                    </div>
                                    <div class="relative">
                                        <select id="citySelect" disabled class="w-full pl-3 pr-8 py-3 bg-white dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-xl text-sm font-medium text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none appearance-none truncate disabled:opacity-60 disabled:cursor-not-allowed transition-all">
                                            <option value="">é€‰æ‹©åŸå¸‚</option>
                                        </select>
                                        <i class="ph-bold ph-caret-down absolute right-3 top-3.5 text-slate-400 pointer-events-none"></i>
                                    </div>
                                </div>
                                
                                <!-- ç»çº¬åº¦æ‰‹åŠ¨/è‡ªåŠ¨æ˜¾ç¤ºåŒºåŸŸ -->
                                <div class="space-y-1.5">
                                    <div class="flex justify-between items-end" id="geo-toggle-container">
                                        <label class="text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">
                                            ç»çº¬åº¦åæ ‡
                                        </label>
                                        <button type="button" id="manualGeoBtn" class="text-xs text-brand-600 dark:text-brand-400 hover:text-brand-700 dark:hover:text-brand-300 font-medium hover:underline transition-colors">
                                            æŸ¥çœ‹/ä¿®æ”¹
                                        </button>
                                    </div>
                                    <div id="geo-input-container" class="grid grid-cols-2 gap-2 hidden">
                                        <div class="relative">
                                            <input type="text" id="lat" placeholder="çº¬åº¦ (Lat)" class="w-full pl-3 pr-3 py-2.5 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-sm font-mono text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none" readonly>
                                        </div>
                                        <div class="relative">
                                            <input type="text" id="lng" placeholder="ç»åº¦ (Lng)" class="w-full pl-3 pr-3 py-2.5 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-sm font-mono text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none" readonly>
                                        </div>
                                    </div>
                                    <p id="geo-tip" class="hidden text-xs text-slate-500 dark:text-slate-400 leading-relaxed mt-1">
                                        ğŸ’¡ è‡ªåŠ¨æ ¹æ®é€‰æ‹©åœ°ç‚¹è·å–ï¼Œå¦‚å¤±è´¥è¯·æ‰‹åŠ¨è¾“å…¥<br>
                                        <span class="text-[10px]">æ ¼å¼ç¤ºä¾‹: 39.9042 (åŒ—çº¬ä¸ºæ­£), 116.4074 (ä¸œç»ä¸ºæ­£)</span>
                                    </p>
                                </div>
                            </div>

                            <!-- ç¬¬äºŒè¡Œï¼šæ—¥æœŸ -->
                            <div class="space-y-1.5 input-group">
                                <label class="text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">æ—¥æœŸ</label>
                                <div class="relative">
                                    <input type="date" id="date" class="w-full pl-10 pr-4 py-3 bg-white dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-xl text-sm font-medium text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all">
                                    <i class="ph ph-calendar-blank absolute left-3 top-3.5 text-slate-400"></i>
                                </div>
                            </div>

                            <!-- API çŠ¶æ€ä¸åŠ è½½æ¡ -->
                            <div id="api-status-container" class="hidden">
                                <div class="flex items-center justify-between text-xs mb-2">
                                    <span id="api-msg" class="text-slate-600 dark:text-slate-300 font-medium">æ­£åœ¨è¿æ¥å«æ˜Ÿæ•°æ®...</span>
                                </div>
                                <div class="h-1.5 w-full bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
                                    <div id="api-progress" class="h-full bg-brand-500 w-0 transition-all duration-1000"></div>
                                </div>
                            </div>

                            <!-- ç¬¬äºŒè¡Œï¼šæ™¨æš®å…‰æ•°æ® (è‡ªåŠ¨è·å–) -->
                            <div class="p-5 bg-gradient-to-br from-slate-50 to-blue-50/30 dark:from-slate-800/80 dark:to-slate-800/50 rounded-xl border-2 border-slate-200 dark:border-slate-700 space-y-4 relative group shadow-sm">
                                <div class="flex justify-between items-center">
                                    <h3 class="text-xs font-bold text-slate-600 dark:text-slate-300 uppercase tracking-wide flex items-center gap-2">
                                        <i class="ph-duotone ph-sun-dim text-amber-500"></i>
                                        å¤©æ–‡èŠ‚ç‚¹æ•°æ® (è‡ªåŠ¨)
                                    </h3>
                                    <button type="button" id="toggleManual" class="text-xs text-brand-600 dark:text-brand-400 hover:text-brand-700 dark:hover:text-brand-300 font-medium opacity-0 group-hover:opacity-100 transition-all hover:underline">
                                        è§£é”ç¼–è¾‘
                                    </button>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-semibold text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1">
                                            <i class="ph-fill ph-sun-horizon text-orange-500"></i>
                                            æ°‘ç”¨æ™¨å…‰å§‹
                                        </label>
                                        <div class="relative">
                                            <input type="time" id="twilightBegin" step="1" readonly class="w-full pl-3 pr-3 py-3 bg-white dark:bg-slate-900 border-2 border-orange-200 dark:border-orange-900/50 rounded-lg text-slate-700 dark:text-slate-200 font-mono text-base font-semibold focus:bg-white dark:focus:bg-slate-800 focus:ring-2 focus:ring-orange-400 focus:border-orange-400 transition-all shadow-sm">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1">
                                            <i class="ph-fill ph-moon-stars text-indigo-500"></i>
                                            æ°‘ç”¨æš®å…‰ç»ˆ
                                        </label>
                                        <div class="relative">
                                            <input type="time" id="twilightEnd" step="1" readonly class="w-full pl-3 pr-3 py-3 bg-white dark:bg-slate-900 border-2 border-indigo-200 dark:border-indigo-900/50 rounded-lg text-slate-700 dark:text-slate-200 font-mono text-base font-semibold focus:bg-white dark:focus:bg-slate-800 focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all shadow-sm">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ç¬¬ä¸‰è¡Œï¼šæŸ¥è¯¢æ—¶é—´ä¸æŒ‰é’® -->
                            <div class="pt-2">
                                <label class="text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider mb-1.5 block">æŸ¥è¯¢æ—¶é—´ç‚¹</label>
                                <div class="flex gap-3">
                                <div class="relative flex-1">
                                    <input type="time" id="targetTime" step="1" required class="w-full pl-12 pr-4 py-3.5 bg-white dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-xl text-lg font-semibold text-slate-700 dark:text-slate-200 shadow-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all">
                                    <i class="ph-duotone ph-watch absolute left-4 top-4 text-xl text-slate-400"></i>
                                </div>
                                    <button type="submit" class="px-6 py-3 bg-brand-600 hover:bg-brand-700 text-white rounded-xl font-medium shadow-lg shadow-brand-500/20 active:scale-95 transition-all flex items-center gap-2">
                                        <i class="ph-bold ph-calculator"></i>
                                        <span class="hidden md:inline">å¼€å§‹è®¡ç®—</span>
                                        <span class="md:hidden">è®¡ç®—</span>
                                    </button>
                                </div>
                            </div>
                        </form>

                        <!-- é”™è¯¯æç¤º -->
                        <div id="error-box" class="hidden p-4 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-800 flex gap-3 items-start animate-slide-in">
                            <i class="ph-fill ph-warning-circle text-red-500 text-xl mt-0.5"></i>
                            <p class="text-sm text-red-600 dark:text-red-300 leading-relaxed"></p>
                        </div>

                        <!-- è®¡ç®—ç»“æœå±•ç¤º -->
                        <div id="result-box" class="hidden animate-slide-in">
                            <div class="relative p-4 sm:p-6 rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-slate-800 dark:to-slate-800 border border-blue-100 dark:border-slate-600 overflow-hidden">
                                <!-- è£…é¥°èƒŒæ™¯ -->
                                <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-brand-400/10 rounded-full blur-xl"></div>
                                
                                <div class="text-center relative z-10">
                                    <p class="text-[10px] sm:text-xs font-bold text-brand-600 dark:text-brand-400 uppercase tracking-widest mb-1">å½“å‰æ—¶é—´æ‰€å±</p>
                                    <h1 id="shichenName" class="text-4xl sm:text-5xl md:text-6xl font-black text-slate-800 dark:text-white mb-2 tracking-tight"></h1>
                                    <div id="shichenRange" class="inline-flex items-center gap-1 sm:gap-1.5 px-2 sm:px-3 py-1 rounded-md bg-white/60 dark:bg-black/20 text-xs sm:text-sm font-mono text-slate-600 dark:text-slate-300 border border-white/50 dark:border-white/5">
                                        <!-- åŒºé—´æ—¶é—´ -->
                                    </div>
                                </div>
                            </div>

                            <!-- è¯¦ç»†åˆ—è¡¨æŠ˜å  -->
                            <div class="mt-4">
                                <button id="toggleDetails" class="flex w-full items-center justify-between px-4 py-2 text-sm text-slate-500 hover:text-brand-600 transition-colors rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800">
                                    <span>æŸ¥çœ‹å½“æ—¥å®Œæ•´æ—¶è¾°è¡¨</span>
                                    <i class="ph-bold ph-caret-down transition-transform duration-300"></i>
                                </button>
                                <div id="details-panel" class="hidden mt-2 p-3 sm:p-4 bg-slate-50 dark:bg-slate-900/50 rounded-xl border border-slate-100 dark:border-slate-700 overflow-hidden">
                                    <div id="details-content" class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs sm:text-sm font-mono"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- å³ä¾§ï¼šå¥‡ä»ªå¯¹åº” (å  5 åˆ—) -->
            <div class="lg:col-span-5 space-y-6">
                <section class="glass-panel rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 h-full">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700/50 bg-gradient-to-r from-slate-50 to-white dark:from-slate-800 dark:to-slate-800">
                        <h2 class="text-lg font-bold flex items-center gap-2 text-slate-800 dark:text-white">
                            <i class="ph-duotone ph-compass text-purple-500 text-xl"></i>
                            å¥‡ä»ªæ’ç›˜æŸ¥è¯¢
                        </h2>
                    </div>
                    
                    <div class="p-6 space-y-8">
                        <!-- åŠŸèƒ½ A -->
                        <div class="space-y-4">
                            <h3 class="text-sm font-bold text-slate-600 dark:text-slate-300 flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-purple-500"></span>
                                å·²çŸ¥ç”¨ç¥ï¼ŒåæŸ¥ç”²
                            </h3>
                            <div class="grid grid-cols-2 gap-3">
                                <select id="find-jia-gan" class="w-full px-3 py-2.5 bg-white dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-lg text-sm font-medium text-slate-700 dark:text-slate-200 outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all">
                                    <option value="ä¹™">å¤©å¹²: ä¹™</option><option value="ä¸™">å¤©å¹²: ä¸™</option><option value="ä¸">å¤©å¹²: ä¸</option>
                                    <option value="æˆŠ">å¤©å¹²: æˆŠ</option><option value="å·±">å¤©å¹²: å·±</option><option value="åºš">å¤©å¹²: åºš</option>
                                    <option value="è¾›">å¤©å¹²: è¾›</option><option value="å£¬">å¤©å¹²: å£¬</option><option value="ç™¸">å¤©å¹²: ç™¸</option>
                                </select>
                                <select id="find-jia-menxing" class="w-full px-3 py-2.5 bg-white dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-lg text-sm font-medium text-slate-700 dark:text-slate-200 outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all"></select>
                            </div>
                            <button onclick="findJia()" class="w-full py-2.5 bg-slate-100 dark:bg-slate-700 hover:bg-purple-50 dark:hover:bg-purple-900/30 text-slate-700 dark:text-slate-200 hover:text-purple-600 dark:hover:text-purple-400 rounded-lg text-sm font-semibold transition-all border border-slate-200 dark:border-slate-600 hover:border-purple-300 dark:hover:border-purple-700">
                                æŸ¥è¯¢ç”²ä½
                            </button>
                            <div id="find-jia-result" class="hidden p-3 text-center text-sm rounded-lg border border-dashed"></div>
                        </div>

                        <div class="border-t border-slate-100 dark:border-slate-700"></div>

                        <!-- åŠŸèƒ½ B -->
                        <div class="space-y-4">
                            <h3 class="text-sm font-bold text-slate-600 dark:text-slate-300 flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-pink-500"></span>
                                å·²çŸ¥ç”²ï¼Œæ­£æŸ¥ç”¨ç¥
                            </h3>
                            <div class="grid grid-cols-2 gap-3">
                                <select id="find-other-jia-menxing" class="w-full px-3 py-2.5 bg-white dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-lg text-sm font-medium text-slate-700 dark:text-slate-200 outline-none focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20 transition-all"></select>
                                <select id="find-other-gan" class="w-full px-3 py-2.5 bg-white dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 rounded-lg text-sm font-medium text-slate-700 dark:text-slate-200 outline-none focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20 transition-all">
                                    <option value="ä¹™">æ‰¾: ä¹™</option><option value="ä¸™">æ‰¾: ä¸™</option><option value="ä¸">æ‰¾: ä¸</option>
                                    <option value="æˆŠ">æ‰¾: æˆŠ</option><option value="å·±">æ‰¾: å·±</option><option value="åºš">æ‰¾: åºš</option>
                                    <option value="è¾›">æ‰¾: è¾›</option><option value="å£¬">æ‰¾: å£¬</option><option value="ç™¸">æ‰¾: ç™¸</option>
                                </select>
                            </div>
                            <button onclick="findOther()" class="w-full py-2.5 bg-slate-100 dark:bg-slate-700 hover:bg-pink-50 dark:hover:bg-pink-900/30 text-slate-700 dark:text-slate-200 hover:text-pink-600 dark:hover:text-pink-400 rounded-lg text-sm font-semibold transition-all border border-slate-200 dark:border-slate-600 hover:border-pink-300 dark:hover:border-pink-700">
                                æŸ¥è¯¢ç”¨ç¥
                            </button>
                            <div id="find-other-result" class="hidden p-3 text-center text-sm rounded-lg border border-dashed"></div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- é€»è¾‘è„šæœ¬ -->
    <script>
        // --- 1. æ•°æ®ä¸é…ç½® ---
        
        const API_KEY = "629dd8faf6d54b579b0d7b20b63c4f11";
        let pcaData = []; // çœå¸‚åŒºæ•°æ®ç¼“å­˜

        // å¥‡ä»ªå¯¹åº”å…³ç³»
        const correspondences = {
            "æœé—¨/å¤©è¾…": { "ä¹™": "ä¼‘é—¨/å¤©è“¬", "ä¸™": "ç”Ÿé—¨/å¤©ä»»", "æˆŠ": "ç”Ÿé—¨/å¤©ä»»", "ä¸": "ä¼¤é—¨/å¤©å†²", "å·±": "ä¼¤é—¨/å¤©å†²", "åºš": "å¼€é—¨/å¤©å¿ƒ", "è¾›": "æ™¯é—¨/å¤©è‹±", "å£¬": "æ­»é—¨/å¤©èŠ®", "ç™¸": "æƒŠé—¨/å¤©æŸ±" },
            "æ™¯é—¨/å¤©è‹±": { "ä¹™": "å¼€é—¨/å¤©å¿ƒ", "ä¸™": "ä¼¤é—¨/å¤©å†²", "æˆŠ": "ä¼¤é—¨/å¤©å†²", "ä¸": "ç”Ÿé—¨/å¤©ä»»", "å·±": "ç”Ÿé—¨/å¤©ä»»", "åºš": "ä¼‘é—¨/å¤©è“¬", "è¾›": "æœé—¨/å¤©è¾…", "å£¬": "æƒŠé—¨/å¤©æŸ±", "ç™¸": "æ­»é—¨/å¤©èŠ®" },
            "æ­»é—¨/å¤©èŠ®": { "ä¹™": "æƒŠé—¨/å¤©æŸ±", "ä¸™": "æœé—¨/å¤©è¾…", "æˆŠ": "æœé—¨/å¤©è¾…", "ä¸": "ä¼‘é—¨/å¤©è“¬", "å·±": "ä¼‘é—¨/å¤©è“¬", "åºš": "ç”Ÿé—¨/å¤©ä»»", "è¾›": "ä¼¤é—¨/å¤©å†²", "å£¬": "å¼€é—¨/å¤©å¿ƒ", "ç™¸": "æ™¯é—¨/å¤©è‹±" },
            "ä¼¤é—¨/å¤©å†²": { "ä¹™": "ç”Ÿé—¨/å¤©ä»»", "ä¸™": "ä¼‘é—¨/å¤©è“¬", "æˆŠ": "ä¼‘é—¨/å¤©è“¬", "ä¸": "æœé—¨/å¤©è¾…", "å·±": "æœé—¨/å¤©è¾…", "åºš": "æƒŠé—¨/å¤©æŸ±", "è¾›": "æ­»é—¨/å¤©èŠ®", "å£¬": "æ™¯é—¨/å¤©è‹±", "ç™¸": "å¼€é—¨/å¤©å¿ƒ" },
            "æƒŠé—¨/å¤©æŸ±": { "ä¹™": "æ­»é—¨/å¤©èŠ®", "ä¸™": "æ™¯é—¨/å¤©è‹±", "æˆŠ": "æ™¯é—¨/å¤©è‹±", "ä¸": "å¼€é—¨/å¤©å¿ƒ", "å·±": "å¼€é—¨/å¤©å¿ƒ", "åºš": "ä¼¤é—¨/å¤©å†²", "è¾›": "ç”Ÿé—¨/å¤©ä»»", "å£¬": "ä¼‘é—¨/å¤©è“¬", "ç™¸": "æœé—¨/å¤©è¾…" },
            "ç”Ÿé—¨/å¤©ä»»": { "ä¹™": "ä¼¤é—¨/å¤©å†²", "ä¸™": "å¼€é—¨/å¤©å¿ƒ", "æˆŠ": "å¼€é—¨/å¤©å¿ƒ", "ä¸": "æ™¯é—¨/å¤©è‹±", "å·±": "æ™¯é—¨/å¤©è‹±", "åºš": "æ­»é—¨/å¤©èŠ®", "è¾›": "æƒŠé—¨/å¤©æŸ±", "å£¬": "æœé—¨/å¤©è¾…", "ç™¸": "ä¼‘é—¨/å¤©è“¬" },
            "ä¼‘é—¨/å¤©è“¬": { "ä¹™": "æœé—¨/å¤©è¾…", "ä¸™": "æƒŠé—¨/å¤©æŸ±", "æˆŠ": "æƒŠé—¨/å¤©æŸ±", "ä¸": "æ­»é—¨/å¤©èŠ®", "å·±": "æ­»é—¨/å¤©èŠ®", "åºš": "æ™¯é—¨/å¤©è‹±", "è¾›": "å¼€é—¨/å¤©å¿ƒ", "å£¬": "ä¼¤é—¨/å¤©å†²", "ç™¸": "ç”Ÿé—¨/å¤©ä»»" },
            "å¼€é—¨/å¤©å¿ƒ": { "ä¹™": "æ™¯é—¨/å¤©è‹±", "ä¸™": "æ­»é—¨/å¤©èŠ®", "æˆŠ": "æ­»é—¨/å¤©èŠ®", "ä¸": "æƒŠé—¨/å¤©æŸ±", "å·±": "æƒŠé—¨/å¤©æŸ±", "åºš": "æœé—¨/å¤©è¾…", "è¾›": "ä¼‘é—¨/å¤©è“¬", "å£¬": "ç”Ÿé—¨/å¤©ä»»", "ç™¸": "ä¼¤é—¨/å¤©å†²" }
        };

        // --- 2. API ä¸æ•°æ®è·å– ---

        // const apiKeyInput = document.getElementById('apiKey'); // å·²åºŸå¼ƒ
        // const saveKeyBtn = document.getElementById('saveKeyBtn'); // å·²åºŸå¼ƒ
        
        // æ–°çš„åœ°å€é€‰æ‹©å…ƒç´ 
        const provinceSelect = document.getElementById('provinceSelect');
        const citySelect = document.getElementById('citySelect');
        const geoStatus = document.getElementById('geo-status');
        const latInput = document.getElementById('lat');
        const lngInput = document.getElementById('lng');

        const dateInput = document.getElementById('date');
        const apiStatusContainer = document.getElementById('api-status-container');
        const apiMsg = document.getElementById('api-msg');
        const apiProgress = document.getElementById('api-progress');
        const twilightBeginInput = document.getElementById('twilightBegin');
        const twilightEndInput = document.getElementById('twilightEnd');

        // åŠ è½½çœå¸‚åŒºæ•°æ®
        async function loadPCAData() {
            try {
                geoStatus.textContent = "æ­£åœ¨åŠ è½½åŸå¸‚æ•°æ®...";
                // ä½¿ç”¨ jsdelivr åŠ è½½ github ä¸Šçš„ json
                const res = await fetch('https://unpkg.com/china-division/dist/pcas-code.json');
                if(!res.ok) throw new Error("åŸå¸‚æ•°æ®åŠ è½½å¤±è´¥");
                pcaData = await res.json();
                
                // å¡«å……çœä»½
                provinceSelect.innerHTML = '<option value="">çœä»½</option>';
                pcaData.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.name;
                    opt.text = p.name;
                    provinceSelect.add(opt);
                });
                geoStatus.textContent = "ğŸ‘‡ è¯·é€‰æ‹©åœ°ç‚¹";
            } catch (e) {
                geoStatus.textContent = "âŒ åŸå¸‚æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°";
                console.error(e);
            }
        }

        // è”åŠ¨é€»è¾‘
        function updateCities() {
            const pName = provinceSelect.value;
            citySelect.innerHTML = '<option value="">åŸå¸‚</option>';
            citySelect.disabled = true;

            if(!pName) return;

            const pData = pcaData.find(p => p.name === pName);
            if(pData && pData.children) {
                pData.children.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.name;
                    opt.text = c.name;
                    citySelect.add(opt);
                });
                citySelect.disabled = false;
            }
        }

        // è·å–ç»çº¬åº¦ (ä¼˜å…ˆä½¿ç”¨ Open-Meteoï¼ŒOpenStreetMap ä½œä¸ºå¤‡é€‰)
        let geoTimeout;
        async function fetchCoordinates() {
            const p = provinceSelect.value;
            const c = citySelect.value;

            if(!p) return;

            // æ„å»ºæŸ¥è¯¢å­—ç¬¦ä¸²
            let query = c || p;

            geoStatus.textContent = "æ­£åœ¨è‡ªåŠ¨å®šä½...";
            geoStatus.className = "text-[11px] font-semibold text-brand-600 dark:text-brand-400";
            
            // é”å®šè¾“å…¥æ¡†
            if(!latInput.hasAttribute('readonly')) {
                lockGeoInputs();
            }

            clearTimeout(geoTimeout);
            geoTimeout = setTimeout(async () => {
                try {
                    // 1. å°è¯• Open-Meteo Geocoding API
                    // æˆ‘ä»¬éœ€è¦è·å– "name" (è‹±æ–‡å) å’Œ "latitude/longitude"
                    const searchName = c || p;
                    const omUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(searchName)}&count=5&language=zh&format=json`;
                    
                    let lat, lng, foundName, englishName;
                    
                    const res = await fetch(omUrl);
                    const data = await res.json();

                    if(data.results && data.results.length > 0) {
                        const item = data.results.find(i => i.country_code === 'CN') || data.results[0];
                        lat = item.latitude;
                        lng = item.longitude;
                        foundName = item.name; 
                        
                    } else {
                        // 2. å¦‚æœ Open-Meteo æ²¡æ‰¾åˆ°ï¼Œå°è¯• Nominatim
                        console.log("Open-Meteoæœªæ‰¾åˆ°ï¼Œåˆ‡æ¢è‡³OSM...");
                        const osmQuery = `ä¸­å›½ ${p} ${c || ''}`;
                        const osmUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(osmQuery)}&format=json&limit=1&addressdetails=1&accept-language=zh-CN`;
                        
                        const res2 = await fetch(osmUrl);
                        if(!res2.ok) throw new Error("Geo Service Unavailable");
                        const data2 = await res2.json();
                        
                        if(data2 && data2.length > 0) {
                            lat = parseFloat(data2[0].lat);
                            lng = parseFloat(data2[0].lon);
                            foundName = data2[0].display_name.split(',')[0];
                        } else {
                            throw new Error("æœªæ‰¾åˆ°ä½ç½®ä¿¡æ¯");
                        }
                    }

                    // æˆåŠŸè·å–
                    if(lat && lng) {
                        latInput.value = parseFloat(lat).toFixed(4);
                        lngInput.value = parseFloat(lng).toFixed(4);
                        
                        geoStatus.textContent = `âœ“ å·²å®šä½: ${foundName || (c||p)}`;
                        geoStatus.className = "text-[11px] font-bold text-green-600 dark:text-green-400";
                        
                        // å…³é”®ï¼šéšè—ç»çº¬åº¦è¾“å…¥æ¡†åŒºåŸŸï¼Œè®©ç”¨æˆ·æ„Ÿè§‰ä¸åˆ°å®ƒä»¬çš„å­˜åœ¨
                        // (æˆ‘ä¼šåœ¨CSSé‡Œå¤„ç†è¿™ä¸ªæ˜¾éšï¼Œæˆ–è€…åœ¨è¿™é‡ŒåŠ¨æ€éšè—)
                        document.getElementById('geo-input-container').classList.add('hidden');
                        document.getElementById('geo-toggle-container').classList.remove('hidden'); // æ˜¾ç¤ºä¸€ä¸ªå°æŒ‰é’®å…è®¸å±•å¼€

                        // è‡ªåŠ¨è§¦å‘æ—¥å‡ºæ—¥è½æŸ¥è¯¢
                        fetchSunTimes();
                    }
                } catch (e) {
                    console.error(e);
                    // å¤±è´¥æ—¶æ‰æ˜¾ç¤ºè¾“å…¥æ¡†
                    document.getElementById('geo-input-container').classList.remove('hidden');
                    geoStatus.textContent = "âš  è‡ªåŠ¨å®šä½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥";
                    geoStatus.className = "text-[11px] font-bold text-red-600 dark:text-red-400";
                    unlockGeoInputs();
                }
            }, 800); 
        }

        function unlockGeoInputs() {
            latInput.removeAttribute('readonly');
            lngInput.removeAttribute('readonly');
            latInput.classList.remove('bg-slate-50', 'dark:bg-slate-900');
            latInput.classList.add('bg-white', 'dark:bg-slate-800', 'border-brand-400');
            lngInput.classList.remove('bg-slate-50', 'dark:bg-slate-900');
            lngInput.classList.add('bg-white', 'dark:bg-slate-800', 'border-brand-400');
            document.getElementById('manualGeoBtn').textContent = "é”å®šåæ ‡";
            document.getElementById('geo-input-container').classList.remove('hidden');
            document.getElementById('geo-tip').classList.remove('hidden');
        }

        function lockGeoInputs() {
            latInput.setAttribute('readonly', true);
            lngInput.setAttribute('readonly', true);
            latInput.classList.add('bg-slate-50', 'dark:bg-slate-900');
            latInput.classList.remove('bg-white', 'dark:bg-slate-800', 'border-brand-400');
            lngInput.classList.add('bg-slate-50', 'dark:bg-slate-900');
            lngInput.classList.remove('bg-white', 'dark:bg-slate-800', 'border-brand-400');
            document.getElementById('manualGeoBtn').textContent = "æŸ¥çœ‹/ä¿®æ”¹";
            // document.getElementById('geo-input-container').classList.add('hidden'); // ä¿æŒæ˜¾ç¤ºæˆ–éšè—å–å†³äºç”¨æˆ·æ˜¯å¦ç‚¹å¼€äº†
        }

        // æ‰‹åŠ¨ä¿®æ”¹æŒ‰é’®é€»è¾‘
        document.getElementById('manualGeoBtn').addEventListener('click', function() {
            const container = document.getElementById('geo-input-container');
            const tip = document.getElementById('geo-tip');
            
            if(container.classList.contains('hidden')) {
                // å±•å¼€
                container.classList.remove('hidden');
                tip.classList.remove('hidden');
                this.textContent = "é”å®šåæ ‡"; // é»˜è®¤å±•å¼€æ—¶å¯èƒ½æ˜¯ä¸ºäº†ä¿®æ”¹ï¼Ÿæˆ–è€…ä»…ä»…æŸ¥çœ‹ã€‚æˆ‘ä»¬å‡è®¾æ˜¯ä¸ºäº†ä¿®æ”¹
                // å¦‚æœå·²ç»æœ‰å€¼ä¸”åªè¯»ï¼Œé‚£å°±æ˜¯æŸ¥çœ‹æ¨¡å¼ï¼Œä¸éœ€è¦è§£é”
                if(latInput.hasAttribute('readonly')) {
                     this.textContent = "ä¿®æ”¹åæ ‡";
                }
            } else {
                // å¦‚æœæ˜¯â€œä¿®æ”¹åæ ‡â€çŠ¶æ€ï¼Œåˆ™ç‚¹å‡»æ„å‘³ç€è§£é”
                if(this.textContent === "ä¿®æ”¹åæ ‡") {
                    unlockGeoInputs();
                } else {
                    // æŠ˜å 
                    container.classList.add('hidden');
                    tip.classList.add('hidden');
                    lockGeoInputs(); // æŠ˜å æ—¶è‡ªåŠ¨é”å®š
                    this.textContent = "æŸ¥çœ‹/ä¿®æ”¹";
                    // é”å®šæ—¶å¦‚æœæœ‰å€¼ï¼Œè§¦å‘è®¡ç®—
                    if(latInput.value && lngInput.value) fetchSunTimes();
                }
            }
        });

        // ç»çº¬åº¦è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶å¦‚æœå·²å¡«æ»¡ï¼Œå°è¯•è®¡ç®—
        [latInput, lngInput].forEach(input => {
            input.addEventListener('change', () => {
                if(latInput.value && lngInput.value && !latInput.hasAttribute('readonly')) {
                    fetchSunTimes();
                }
            });
        });

        // æ ¸å¿ƒï¼šè·å–æ™¨æš®å…‰æ—¶é—´
        async function fetchSunTimes() {
            const apiKey = API_KEY;
            // const locIndex = locationSelect.value; // å·²åºŸå¼ƒ
            const dateStr = dateInput.value;
            const lat = latInput.value;
            const lng = lngInput.value;

            if (!lat || !lng || !dateStr) return;

            // UI Loading State
            apiStatusContainer.classList.remove('hidden');
            apiProgress.style.width = '0%';
            apiMsg.textContent = `æ­£åœ¨è·å–å¤©æ–‡æ•°æ®...`;
            apiMsg.className = "text-brand-600 font-medium";
            
            // Fake progress
            setTimeout(() => apiProgress.style.width = '60%', 100);

            try {
                // æ„å»º API URL
                // ç”¨æˆ·æŒ‡å®šï¼šè§„å®š API è¿”å›ç§’çº§æ•°æ®ã€‚
                // å°è¯•æ·»åŠ  time_format=24 ä¹Ÿå°±æ˜¯è¯·æ±‚å®Œæ•´æ—¶é—´æ ¼å¼ (æ ¹æ®å¸¸è§çš„ API æƒ¯ä¾‹æ¨æµ‹ï¼Œæˆ–è€…ç”¨æˆ·å¯èƒ½æŒ‡çš„æ˜¯ä¸æˆªæ–­)
                const url = `https://api.ipgeolocation.io/v2/astronomy?apiKey=${apiKey}&lat=${lat}&long=${lng}&date=${dateStr}&time_format=24`;
                
                const response = await fetch(url);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || "è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
                }

                // æå–æ°‘ç”¨æ™¨æš®å…‰æ—¶é—´
                // ç›´æ¥ä½¿ç”¨ API è¿”å›çš„æ•°æ®ï¼Œå‡è®¾å·²åŒ…å«ç§’
                let morningStart = data.astronomy.morning.civil_twilight_begin;
                let eveningEnd = data.astronomy.evening.civil_twilight_end;

                // ç®€å•çš„æ ¼å¼æ£€æŸ¥ï¼Œé˜²æ­¢æ•°æ®å®Œå…¨ä¸å¯ç”¨
                if (morningStart && morningStart.indexOf(':') > -1) {
                    twilightBeginInput.value = morningStart;
                }
                if (eveningEnd && eveningEnd.indexOf(':') > -1) {
                    twilightEndInput.value = eveningEnd;
                }

                apiProgress.style.width = '100%';
                apiMsg.innerHTML = `<i class="ph-bold ph-check"></i> è·å–æˆåŠŸ`;
                apiMsg.className = "text-green-600 font-bold";

                // 2ç§’åéšè—
                setTimeout(() => {
                    apiStatusContainer.classList.add('hidden');
                }, 2000);
                
                // è‡ªåŠ¨é‡æ–°è®¡ç®—
                calculate();

            } catch (err) {
                apiProgress.style.width = '100%';
                apiProgress.classList.remove('bg-brand-500');
                apiProgress.classList.add('bg-red-500');
                apiMsg.textContent = `é”™è¯¯: ${err.message}`;
                apiMsg.className = "text-red-600 font-bold";
                console.error(err);
            }
        }

        // --- 3. æ—¶è¾°è®¡ç®—é€»è¾‘ ---
        // ... (ä¿ç•™åŸè®¡ç®—é€»è¾‘) ...


        const shichenForm = document.getElementById('shichenForm');
        const targetTimeInput = document.getElementById('targetTime');
        const errorBox = document.getElementById('error-box');
        const resultBox = document.getElementById('result-box');
        const shichenNameEl = document.getElementById('shichenName');
        const shichenRangeEl = document.getElementById('shichenRange');
        const toggleDetailsBtn = document.getElementById('toggleDetails');
        const detailsPanel = document.getElementById('details-panel');
        const detailsContent = document.getElementById('details-content');

        function parseTime(t) {
            if (!t) return null;
            const [h, m, s = 0] = t.split(':').map(Number);
            return h * 3600 + m * 60 + s;
        }

        function formatTime(sec) {
            sec = Math.floor(sec);
            // Normalize to 24h for display
            let dSec = sec % 86400;
            if (dSec < 0) dSec += 86400;
            const h = Math.floor(dSec / 3600);
            const m = Math.floor((dSec % 3600) / 60);
            const s = dSec % 60;
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        function showError(msg) {
            errorBox.classList.remove('hidden');
            errorBox.querySelector('p').textContent = msg;
            resultBox.classList.add('hidden');
        }

        function calculate() {
            errorBox.classList.add('hidden');
            
            const startStr = twilightBeginInput.value;
            const endStr = twilightEndInput.value;
            const targetStr = targetTimeInput.value;

            if (!startStr || !endStr) {
                showError("è¯·å…ˆè·å–æˆ–è¾“å…¥æ™¨æš®å…‰æ—¶é—´ (éœ€å¡«å†™ API Key å¹¶é€‰æ‹©åœ°ç‚¹)");
                return;
            }
            if (!targetStr) {
                showError("è¯·é€‰æ‹©æŸ¥è¯¢æ—¶é—´");
                return;
            }

            const startSec = parseTime(startStr);
            const endSec = parseTime(endStr);
            const targetSec = parseTime(targetStr);

            if (endSec <= startSec) {
                showError("ç™½æ˜¼ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´");
                return;
            }

            // æ˜¼ä¸ƒå¤œäº”é€»è¾‘
            const dayLen = endSec - startSec;
            const nightLen = 86400 - dayLen;
            
            const dayUnit = dayLen / 7;
            const nightUnit = nightLen / 5;

            const dayNames = ['å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰'];
            const nightNames = ['æˆŒ', 'äº¥', 'å­', 'ä¸‘', 'å¯…'];
            
            let intervals = [];
            let curr = startSec;

            // ç™½å¤©
            dayNames.forEach(name => {
                intervals.push({ name, start: curr, end: curr + dayUnit, type: 'day' });
                curr += dayUnit;
            });

            // å¤œæ™š (ä» endSec å¼€å§‹)
            curr = endSec;
            nightNames.forEach(name => {
                // æ³¨æ„å¤„ç†è·¨å¤©ï¼šå¦‚æœ end > 86400ï¼Œè¡¨ç¤ºç¬¬äºŒå¤©
                intervals.push({ name, start: curr, end: curr + nightUnit, type: 'night' });
                curr += nightUnit;
            });

            // æŸ¥æ‰¾
            let found = null;
            const tolerance = 0.01;

            for (let iv of intervals) {
                // æ ‡å‡†åŒ–æ¯”è¾ƒ
                // æ¯ä¸€ä¸ªåŒºé—´å¯èƒ½æ˜¯ [A, B]ã€‚å¦‚æœ B > 86400ï¼Œè¯´æ˜è·¨å¤©äº†
                // Target ä¹Ÿæ˜¯ 0-86400
                // æƒ…å†µ1ï¼šä¸è·¨å¤©ï¼Œtarget åœ¨ [s, e)
                // æƒ…å†µ2ï¼šè·¨å¤©ï¼Œæ¯”å¦‚ [80000, 90000] -> å®é™…æ˜¯ 22:xx åˆ° 01:xx
                //        target >= 80000 OR target < (90000-86400)
                
                let s = iv.start % 86400;
                let e = iv.end % 86400;
                // å¦‚æœåŸå§‹ end > 86400ï¼Œè¯´æ˜ e æ¯” s å°ï¼ˆæˆ–è€… så¾ˆå¤§ï¼‰ï¼Œå³è·¨å¤©
                let isCross = iv.end >= 86400; // ç®€å•åˆ¤æ–­: ç´¯åŠ æ—¶è‚¯å®šä¼šè¶…è¿‡
                
                // æ›´ä¸¥è°¨çš„åˆ¤æ–­é€»è¾‘ï¼š
                // å¦‚æœåŒºé—´æœªè·¨è¶Šåˆå¤œ (start < end ä¸” end < 86400)
                // æˆ‘ä»¬çš„ intervals æ„å»ºæ–¹å¼æ˜¯çº¿æ€§çš„ï¼Œnight éƒ¨åˆ†è‚¯å®šä¼šè¶…è¿‡ 86400
                
                // å°† target æ˜ å°„åˆ°ç›¸å¯¹äº startSec çš„çº¿æ€§è½´ä¸Šæ¯”è¾ƒå›°éš¾ï¼Œä¸å¦‚ç›´æ¥åˆ¤æ–­èŒƒå›´
                // æˆ‘ä»¬å¯ä»¥ç›´æ¥æ£€æŸ¥ target æ˜¯å¦è½åœ¨ [start, end) 
                // ä½†æ˜¯ target æ˜¯ 0-24hã€‚å¦‚æœ interval æ˜¯ 23:00-25:00 (å³æ¬¡æ—¥01:00)
                // targetå¦‚æœæ˜¯ 00:30ï¼Œåº”è¯¥åŒ¹é…ã€‚
                
                // è½¬æ¢é€»è¾‘ï¼š
                // å¦‚æœ interval.start < interval.end (æœªè·¨å¤©ï¼Œä¸”éƒ½åœ¨24hå†…? ä¸ä¸€å®šï¼Œnightéƒ¨åˆ†éƒ½åœ¨startä¹‹å)
                // å®é™…ä¸Šï¼Œnight éƒ¨åˆ†çš„ curr æ˜¯ä¸æ–­ç´¯åŠ çš„ï¼Œæœ€ç»ˆä¼šè¾¾åˆ° startSec + 86400
                
                // åˆ¤å®šé€»è¾‘ï¼š
                // 1. è®¡ç®— target ç›¸å¯¹äº "å½“å¤©" çš„åç§»ã€‚
                // å¦‚æœ target < startSec (é»æ˜å‰)ï¼Œå®ƒå¯èƒ½å±äºå‰ä¸€å¤©çš„"å¯…"æ—¶? 
                // ä¸ï¼Œè¿™é‡Œçš„é€»è¾‘æ˜¯è®¡ç®— "è¯¥æ—¥æœŸçš„æ—¶è¾°åˆ’åˆ†"ã€‚
                // å¦‚æœå½“å‰æ—¶é—´æ˜¯å‡Œæ™¨ 01:00ï¼Œä¸”æ—¥å‡ºæ˜¯ 06:00ã€‚
                // é‚£ä¹ˆ 01:00 å±äºæ˜¨å¤œçš„å»¶ç»­ï¼Ÿè¿˜æ˜¯ä»Šå¤©çš„æ—©æ™¨ï¼Ÿ
                // åœ¨å¥‡é—¨/å…«å­—é‡Œï¼Œå­æ—¶æ¢æ—¥ã€‚
                // ä½†â€œå˜åŠ¨æ—¶è¾°â€é€šå¸¸æŒ‡ï¼šä»¥æ—¥å‡ºä¸ºå¯ã€‚
                // æ‰€ä»¥ 00:00 - 06:00 è¿™ä¸€æ®µï¼Œåœ¨æˆ‘ä»¬çš„ intervals æ•°ç»„é‡Œï¼Œæ˜¯æ’åœ¨æœ€åçš„ï¼ˆæˆŒäº¥å­ä¸‘å¯…ï¼‰ã€‚
                // æˆ‘ä»¬çš„ intervals[last] (å¯…) ç»“æŸæ—¶é—´ = startSec + 86400ã€‚
                // æ‰€ä»¥å¦‚æœ target < startSecï¼Œæˆ‘ä»¬åº”è¯¥è®¤ä¸ºå®ƒæ˜¯ intervals é‡Œçš„ä¸€éƒ¨åˆ†å—ï¼Ÿ
                // åº”è¯¥æŠŠ target åŠ ä¸Š 86400 æ¥æ¯”è¾ƒï¼Ÿæˆ–è€…è®¤ä¸ºå®ƒæ˜¯è¿™ä¸€è½®å¾ªç¯çš„å°¾éƒ¨ã€‚
                
                // ç®€å•åšæ³•ï¼šå¦‚æœ target < startSecï¼ŒæŠŠå®ƒçœ‹ä½œ target + 86400 (å³ç¬¬äºŒå¤©å‡Œæ™¨) æ¥ä¸ intervals æ¯”è¾ƒ
                // æ¯”å¦‚ target = 02:00 (7200s), start = 06:00 (21600s).
                // 7200 < 21600, æ‰€ä»¥æ¯”è¾ƒå€¼æ˜¯ 7200 + 86400 = 93600.
                // æˆ‘ä»¬çš„ interval å¯…æ—¶å¯èƒ½æ˜¯ [90000, 108000]ã€‚ 93600 åœ¨é‡Œé¢ -> åŒ¹é…æˆåŠŸã€‚
                
                let compTarget = targetSec;
                if (targetSec < startSec) {
                    compTarget += 86400;
                }
                
                if (compTarget >= iv.start - tolerance && compTarget < iv.end - tolerance) {
                    found = iv;
                    break;
                }
            }

            if (found) {
                shichenNameEl.textContent = found.name + 'æ—¶';
                shichenNameEl.className = `text-5xl font-black tracking-tight mb-2 ${found.type === 'day' ? 'text-orange-500' : 'text-indigo-500'}`;
                
                shichenRangeEl.innerHTML = `
                    <i class="${found.type === 'day' ? 'ph-fill ph-sun' : 'ph-fill ph-moon'}"></i>
                    <span>${formatTime(found.start)} - ${formatTime(found.end)}</span>
                `;

                // æ¸²æŸ“è¯¦æƒ…
                let html = '';
                intervals.forEach(iv => {
                    let isCurrent = iv.name === found.name;
                    let cls = isCurrent 
                        ? 'bg-brand-100 dark:bg-brand-900/40 text-brand-700 dark:text-brand-300 border-brand-200 dark:border-brand-700' 
                        : 'bg-white dark:bg-slate-800 text-slate-500 border-slate-100 dark:border-slate-700';
                    
                    html += `
                        <div class="p-2 sm:p-2.5 rounded border ${cls} flex justify-between items-center gap-2">
                            <span class="font-bold text-sm sm:text-base whitespace-nowrap">${iv.name}æ—¶</span>
                            <span class="opacity-80 text-xs sm:text-sm whitespace-nowrap">${formatTime(iv.start)} - ${formatTime(iv.end)}</span>
                        </div>
                    `;
                });
                detailsContent.innerHTML = html;
                resultBox.classList.remove('hidden');
            } else {
                showError("æ— æ³•è®¡ç®—æ—¶è¾° (æ—¶é—´è¶…å‡ºèŒƒå›´)");
            }
        }

        shichenForm.addEventListener('submit', (e) => {
            e.preventDefault();
            calculate();
        });

        // --- 4. å¥‡ä»ªé€»è¾‘ ---

        function populateSelects() {
            const opts = Object.keys(correspondences).map(k => `<option value="${k}">${k}</option>`).join('');
            const def1 = '<option value="" disabled selected>é€‰æ‹©é—¨/æ˜Ÿ</option>';
            const def2 = '<option value="" disabled selected>ç”²åœ¨é—¨/æ˜Ÿ</option>';
            document.getElementById('find-jia-menxing').innerHTML = def1 + opts;
            document.getElementById('find-other-jia-menxing').innerHTML = def2 + opts;
        }

        function findJia() {
            const gan = document.getElementById('find-jia-gan').value;
            const mx = document.getElementById('find-jia-menxing').value;
            const resDiv = document.getElementById('find-jia-result');
            
            if (!mx) return;
            resDiv.classList.remove('hidden');
            
            let found = null;
            for(let k in correspondences) {
                if(correspondences[k][gan] === mx) { found = k; break; }
            }

            if(found) {
                resDiv.textContent = `ç”²åœ¨: ${found}`;
                resDiv.className = "p-3 text-center text-sm rounded-lg border border-dashed bg-purple-50 border-purple-200 text-purple-700 dark:bg-purple-900/20 dark:border-purple-800 dark:text-purple-300";
            } else {
                resDiv.textContent = "æ— åŒ¹é…ç»„åˆ";
                resDiv.className = "p-3 text-center text-sm rounded-lg border border-dashed bg-red-50 border-red-200 text-red-600";
            }
        }

        function findOther() {
            const jiaMx = document.getElementById('find-other-jia-menxing').value;
            const gan = document.getElementById('find-other-gan').value;
            const resDiv = document.getElementById('find-other-result');
            
            if(!jiaMx) return;
            resDiv.classList.remove('hidden');

            const res = correspondences[jiaMx]?.[gan];
            if(res) {
                resDiv.textContent = `${gan} åœ¨: ${res}`;
                resDiv.className = "p-3 text-center text-sm rounded-lg border border-dashed bg-pink-50 border-pink-200 text-pink-700 dark:bg-pink-900/20 dark:border-pink-800 dark:text-pink-300";
            } else {
                resDiv.textContent = "æŸ¥è¯¢å¤±è´¥";
                resDiv.className = "p-3 text-center text-sm rounded-lg border border-dashed bg-red-50 border-red-200 text-red-600";
            }
        }

        // --- 5. ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ ---
        
        function initTheme() {
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨æˆ–ç³»ç»Ÿåå¥½
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        
        function toggleTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            
            if (isDark) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        // --- åˆå§‹åŒ– ---
        window.onload = async () => {
            // åˆå§‹åŒ–ä¸»é¢˜
            initTheme();
            
            // loadApiKey(); // å·²åºŸå¼ƒ
            populateSelects();
            
            // å¡«å……æ—¥æœŸ
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth()+1).padStart(2,'0');
            const d = String(now.getDate()).padStart(2,'0');
            dateInput.value = `${y}-${m}-${d}`;
            targetTimeInput.value = now.toTimeString().substring(0,8);

            // åŠ è½½åŸå¸‚æ•°æ®
            await loadPCAData();

            // äº¤äº’ç»‘å®š
            // locationSelect.addEventListener('change', fetchSunTimes); // å·²åºŸå¼ƒ
            provinceSelect.addEventListener('change', () => { updateCities(); fetchCoordinates(); });
            citySelect.addEventListener('change', () => { fetchCoordinates(); });

            dateInput.addEventListener('change', fetchSunTimes);

            document.getElementById('toggleManual').addEventListener('click', function() {
                const locked = twilightBeginInput.hasAttribute('readonly');
                if(locked) {
                    twilightBeginInput.removeAttribute('readonly');
                    twilightEndInput.removeAttribute('readonly');
                    this.textContent = "é”å®š";
                } else {
                    twilightBeginInput.setAttribute('readonly', true);
                    twilightEndInput.setAttribute('readonly', true);
                    this.textContent = "è§£é”ç¼–è¾‘";
                }
            });

            document.getElementById('toggleDetails').addEventListener('click', () => {
                detailsPanel.classList.toggle('hidden');
            });
            
            // ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // è‡ªåŠ¨è®¡ç®—ä¸€æ¬¡ï¼ˆå¦‚æœå·²ç»æœ‰åæ ‡ï¼‰
            // ç›®å‰éœ€è¦ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©åœ°ç‚¹
        };
    </script>
</body>
</html>
</html>