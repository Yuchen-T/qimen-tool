<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>å¥‡é—¨éç”²å·¥å…· - å˜åŠ¨æ—¶è¾°è®¡ç®—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    
    <style>
        /* ========== å…¨å±€åŸºç¡€æ ·å¼ ========== */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            overflow-x: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans SC', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            padding: 12px;
        }

        .dark body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        /* ========== å®¹å™¨ (Mobile First) ========== */
        .container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
        }

        /* ========== å¡ç‰‡ç»„ä»¶ ========== */
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            margin-bottom: 16px;
            overflow: hidden;
        }

        .dark .card {
            background: rgba(30, 41, 59, 0.95);
            border-color: rgba(71, 85, 105, 0.5);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            padding: 16px;
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
            background: linear-gradient(to right, rgba(248, 250, 252, 0.5), transparent);
        }

        .dark .card-header {
            border-bottom-color: rgba(71, 85, 105, 0.4);
            background: linear-gradient(to right, rgba(15, 23, 42, 0.5), transparent);
        }

        .card-body {
            padding: 16px;
        }

        /* ========== è¡¨å•å…ƒç´  ========== */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dark .form-label {
            color: #94a3b8;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 12px;
            font-size: 15px;
            border: 2px solid #cbd5e1;
            border-radius: 12px;
            background: #ffffff;
            color: #1e293b;
            transition: all 0.2s;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .dark .form-input,
        .dark .form-select {
            background: #1e293b;
            border-color: #475569;
            color: #e2e8f0;
        }

        .dark .form-input:focus,
        .dark .form-select:focus {
            border-color: #3b82f6;
        }

        .form-input:disabled,
        .form-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Select ä¸‹æ‹‰ç®­å¤´ */
        .select-wrapper {
            position: relative;
        }

        .select-wrapper::after {
            content: '';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 6px solid #64748b;
            pointer-events: none;
        }

        .dark .select-wrapper::after {
            border-top-color: #94a3b8;
        }

        /* ========== æŒ‰é’® ========== */
        .btn {
            width: 100%;
            padding: 14px 20px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3b82f6;
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #cbd5e1;
        }

        .dark .btn-secondary {
            background: #334155;
            color: #cbd5e1;
            border-color: #475569;
        }

        /* ========== ç»“æœå±•ç¤º ========== */
        .result-card {
            background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            margin-top: 16px;
        }

        .dark .result-card {
            background: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);
        }

        .result-title {
            font-size: 48px;
            font-weight: 900;
            color: #1e40af;
            margin: 12px 0;
        }

        .dark .result-title {
            color: #93c5fd;
        }

        .result-range {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            color: #1e40af;
        }

        .dark .result-range {
            background: rgba(0, 0, 0, 0.3);
            color: #bfdbfe;
        }

        /* ========== å·¥å…·æ ·å¼ ========== */
        .hidden {
            display: none !important;
        }

        .text-error {
            color: #ef4444;
        }

        .text-success {
            color: #10b981;
        }

        .dark .text-error {
            color: #fca5a5;
        }

        .dark .text-success {
            color: #6ee7b7;
        }

        /* ========== å“åº”å¼æ–­ç‚¹ (Tablet & Desktop) ========== */
        @media (min-width: 768px) {
            body {
                padding: 24px;
            }

            .container {
                max-width: 1200px;
            }

            .card-body {
                padding: 24px;
            }

            .layout-split {
                display: grid;
                grid-template-columns: 1fr 400px;
                gap: 24px;
                align-items: start;
            }

            .result-title {
                font-size: 64px;
            }
        }

        @media (min-width: 1024px) {
            body {
                padding: 40px;
            }

            .card-body {
                padding: 32px;
            }
        }

        /* ========== åŠ¨ç”» ========== */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }

        /* ========== ä¸»é¢˜åˆ‡æ¢æŒ‰é’® ========== */
        .theme-toggle {
            position: fixed;
            top: 16px;
            right: 16px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
            transition: all 0.2s;
        }

        .dark .theme-toggle {
            background: rgba(30, 41, 59, 0.9);
            border-color: #475569;
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        /* ========== è¯¦æƒ…é¢æ¿ ========== */
        .details-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .details-item {
            padding: 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .dark .details-item {
            background: #1e293b;
            border-color: #334155;
        }

        .details-item.active {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1e40af;
            font-weight: 600;
        }

        .dark .details-item.active {
            background: #1e3a8a;
            border-color: #3b82f6;
            color: #93c5fd;
        }

        @media (min-width: 640px) {
            .details-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ========== å°éƒ¨ä»¶ä¼˜åŒ– ========== */
        .status-badge {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600;
            background: #dbeafe;
            color: #1e40af;
        }

        .dark .status-badge {
            background: #1e3a8a;
            color: #93c5fd;
        }

        .error-box {
            padding: 16px;
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 12px;
            color: #991b1b;
            display: flex;
            gap: 12px;
            align-items: start;
            margin-top: 16px;
        }

        .dark .error-box {
            background: #7f1d1d;
            border-color: #991b1b;
            color: #fecaca;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s ease;
        }

        .dark .progress-bar {
            background: #334155;
        }

        /* ========== æ–°å¢ï¼šæ–‡æœ¬å’Œæ ‡é¢˜æ ·å¼ ========== */
        .header-title {
            text-align: center;
            margin-bottom: 24px;
            padding-top: 8px;
        }

        .main-title {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .dark .main-title {
            color: #f8fafc;
        }

        .subtitle {
            font-size: 14px;
            color: #64748b;
        }

        .dark .subtitle {
            color: #94a3b8;
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dark .card-title {
            color: #f8fafc;
        }

        .section-subtitle {
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 12px;
        }

        .dark .section-subtitle {
            color: #94a3b8;
        }

        .status-text {
            float: right;
            font-size: 11px;
            font-weight: 500;
            color: #64748b;
        }

        .dark .status-text {
            color: #94a3b8;
        }

        .hint-text {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
        }

        .dark .hint-text {
            color: #94a3b8;
        }

        .api-status-text {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 4px;
        }

        .dark .api-status-text {
            color: #94a3b8;
        }

        .result-label {
            font-size: 11px;
            font-weight: 700;
            color: #1e40af;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dark .result-label {
            color: #93c5fd;
        }

        /* ========== æ–°å¢ï¼šé“¾æ¥æŒ‰é’®æ ·å¼ ========== */
        .link-btn {
            font-size: 12px;
            color: #3b82f6;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 0;
            transition: color 0.2s;
        }

        .link-btn:hover {
            color: #2563eb;
            text-decoration: underline;
        }

        .dark .link-btn {
            color: #60a5fa;
        }

        .dark .link-btn:hover {
            color: #93c5fd;
        }

        .small-link-btn {
            font-size: 11px;
            color: #3b82f6;
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.2s;
        }

        .small-link-btn:hover {
            color: #2563eb;
        }

        .dark .small-link-btn {
            color: #60a5fa;
        }

        .dark .small-link-btn:hover {
            color: #93c5fd;
        }

        /* ========== æ–°å¢ï¼šæ™¨æš®å…‰ç›’å­æ ·å¼ ========== */
        .twilight-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
        }

        .dark .twilight-box {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
        }

        .twilight-title {
            font-size: 12px;
            font-weight: 700;
            color: #0369a1;
            text-transform: uppercase;
        }

        .dark .twilight-title {
            color: #7dd3fc;
        }

        .twilight-label {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 4px;
            display: block;
        }

        .dark .twilight-label {
            color: #94a3b8;
        }

        /* ========== æ–°å¢ï¼šæŸ¥è¯¢æŒ‰é’®å’Œç»“æœæ ·å¼ ========== */
        .btn-query {
            width: 100%;
            padding: 12px 20px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 10px;
            border: 1px solid;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-query-purple {
            background: #f3e8ff;
            color: #7e22ce;
            border-color: #e9d5ff;
        }

        .btn-query-purple:active {
            transform: scale(0.98);
            background: #e9d5ff;
        }

        .dark .btn-query-purple {
            background: #581c87;
            color: #e9d5ff;
            border-color: #7e22ce;
        }

        .dark .btn-query-purple:active {
            background: #6b21a8;
        }

        .btn-query-pink {
            background: #fce7f3;
            color: #be185d;
            border-color: #fbcfe8;
        }

        .btn-query-pink:active {
            transform: scale(0.98);
            background: #fbcfe8;
        }

        .dark .btn-query-pink {
            background: #831843;
            color: #fbcfe8;
            border-color: #be185d;
        }

        .dark .btn-query-pink:active {
            background: #9f1239;
        }

        .query-result {
            margin-top: 12px;
            padding: 12px;
            border: 2px dashed;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }

        .query-result-purple {
            background: #f3e8ff;
            border-color: #c084fc;
            color: #6b21a8;
        }

        .dark .query-result-purple {
            background: #581c87;
            border-color: #a855f7;
            color: #e9d5ff;
        }

        .query-result-pink {
            background: #fce7f3;
            border-color: #f9a8d4;
            color: #9f1239;
        }

        .dark .query-result-pink {
            background: #831843;
            border-color: #ec4899;
            color: #fbcfe8;
        }

        /* ========== æ–°å¢ï¼šåˆ†å‰²çº¿æ ·å¼ ========== */
        .divider {
            border-top: 1px solid #e2e8f0;
            margin: 24px 0;
        }

        .dark .divider {
            border-top-color: #475569;
        }
    </style>

    <script>
        tailwind.config = {
            darkMode: 'class',
        }

        // ç«‹å³åˆå§‹åŒ–ä¸»é¢˜ï¼Œé¿å…é—ªçƒ
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</head>
<body>
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button id="themeToggle" class="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">
        <i class="ph-bold ph-sun text-xl hidden dark:inline" style="color: #f59e0b;"></i>
        <i class="ph-bold ph-moon text-xl inline dark:hidden" style="color: #475569;"></i>
    </button>

    <div class="container">
        <!-- æ ‡é¢˜ -->
        <header class="header-title">
            <h1 class="main-title">
                <i class="ph-fill ph-yin-yang" style="color: #3b82f6; font-size: 32px;"></i>
                <span>å¥‡é—¨éç”²å·¥å…·</span>
            </h1>
            <p class="subtitle">åŸºäºæ°‘ç”¨æ™¨æš®å…‰çš„å˜åŠ¨æ—¶è¾°è®¡ç®—</p>
        </header>

        <!-- ä¸»åŠŸèƒ½åŒº -->
        <div class="layout-split">
            <!-- å·¦ä¾§ï¼šæ—¶è¾°è®¡ç®—å™¨ -->
            <div>
                <div class="card">
                    <div class="card-header">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 class="card-title">
                                <i class="ph-duotone ph-clock-afternoon" style="color: #3b82f6; font-size: 20px;"></i>
                                å˜åŠ¨æ—¶è¾°è®¡ç®—å™¨
                            </h2>
                            <span class="status-badge">æ˜¼ä¸ƒå¤œäº”</span>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <form id="shichenForm">
                            <!-- åœ°ç‚¹é€‰æ‹© -->
                            <div class="form-group">
                                <label class="form-label">
                                    <span>åœ°ç‚¹é€‰æ‹©</span>
                                    <span id="geo-status" class="status-text">ç­‰å¾…é€‰æ‹©...</span>
                                </label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <div class="select-wrapper">
                                        <select id="provinceSelect" class="form-select">
                                            <option value="">çœä»½</option>
                                        </select>
                                    </div>
                                    <div class="select-wrapper">
                                        <select id="citySelect" class="form-select" disabled>
                                            <option value="">åŸå¸‚</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- ç»çº¬åº¦ï¼ˆå¯é€‰å±•å¼€ï¼‰ -->
                                <div style="margin-top: 8px;">
                                    <button type="button" id="manualGeoBtn" class="link-btn">
                                        æŸ¥çœ‹/ä¿®æ”¹ç»çº¬åº¦
                                    </button>
                                    <div id="geo-input-container" class="hidden" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
                                        <input type="text" id="lat" placeholder="çº¬åº¦" class="form-input" readonly>
                                        <input type="text" id="lng" placeholder="ç»åº¦" class="form-input" readonly>
                                    </div>
                                    <p id="geo-tip" class="hidden hint-text">
                                        ğŸ’¡ è‡ªåŠ¨è·å–ï¼Œå¦‚å¤±è´¥è¯·æ‰‹åŠ¨è¾“å…¥
                                    </p>
                                </div>
                            </div>

                            <!-- æ—¥æœŸ -->
                            <div class="form-group">
                                <label class="form-label">æ—¥æœŸ</label>
                                <input type="date" id="date" class="form-input">
                            </div>

                            <!-- API åŠ è½½çŠ¶æ€ -->
                            <div id="api-status-container" class="hidden">
                                <div id="api-msg" class="api-status-text">æ­£åœ¨è·å–å¤©æ–‡æ•°æ®...</div>
                                <div class="progress-bar">
                                    <div id="api-progress" class="progress-bar-fill" style="width: 0%;"></div>
                                </div>
                            </div>

                            <!-- æ™¨æš®å…‰æ•°æ® -->
                            <div class="twilight-box">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h3 class="twilight-title">
                                        <i class="ph-duotone ph-sun-dim" style="color: #f59e0b;"></i> å¤©æ–‡èŠ‚ç‚¹æ•°æ®
                                    </h3>
                                    <button type="button" id="toggleManual" class="small-link-btn">
                                        è§£é”ç¼–è¾‘
                                    </button>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label class="twilight-label">
                                            <i class="ph-fill ph-sun-horizon" style="color: #f97316;"></i> æ°‘ç”¨æ™¨å…‰å§‹
                                        </label>
                                        <input type="time" id="twilightBegin" step="1" readonly class="form-input" style="font-family: 'Consolas', monospace;">
                                    </div>
                                    <div>
                                        <label class="twilight-label">
                                            <i class="ph-fill ph-moon-stars" style="color: #6366f1;"></i> æ°‘ç”¨æš®å…‰ç»ˆ
                                        </label>
                                        <input type="time" id="twilightEnd" step="1" readonly class="form-input" style="font-family: 'Consolas', monospace;">
                                    </div>
                                </div>
                            </div>

                            <!-- æŸ¥è¯¢æ—¶é—´ç‚¹ -->
                            <div class="form-group" style="margin-top: 16px;">
                                <label class="form-label">æŸ¥è¯¢æ—¶é—´ç‚¹</label>
                                <input type="time" id="targetTime" step="1" required class="form-input" style="font-size: 18px; font-weight: 600; font-family: 'Consolas', monospace;">
                            </div>

                            <!-- æäº¤æŒ‰é’® -->
                            <button type="submit" class="btn btn-primary">
                                <i class="ph-bold ph-calculator" style="font-size: 20px;"></i>
                                <span>å¼€å§‹è®¡ç®—</span>
                            </button>
                        </form>

                        <!-- é”™è¯¯æç¤º -->
                        <div id="error-box" class="error-box hidden">
                            <i class="ph-fill ph-warning-circle" style="font-size: 20px; flex-shrink: 0;"></i>
                            <p style="margin: 0; font-size: 14px;"></p>
                        </div>

                        <!-- è®¡ç®—ç»“æœ -->
                        <div id="result-box" class="hidden animate-slide-up">
                            <div class="result-card">
                                <p class="result-label">å½“å‰æ—¶é—´æ‰€å±</p>
                                <h1 id="shichenName" class="result-title">â€”</h1>
                                <div id="shichenRange" class="result-range">
                                    <i class="ph-fill ph-sun"></i>
                                    <span>00:00:00 - 00:00:00</span>
                                </div>
                            </div>

                            <!-- è¯¦ç»†åˆ—è¡¨ -->
                            <div style="margin-top: 16px;">
                                <button type="button" id="toggleDetails" class="btn btn-secondary">
                                    <span>æŸ¥çœ‹å½“æ—¥å®Œæ•´æ—¶è¾°è¡¨</span>
                                    <i class="ph-bold ph-caret-down"></i>
                                </button>
                                <div id="details-panel" class="hidden">
                                    <div id="details-content" class="details-grid"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå¥‡ä»ªæŸ¥è¯¢ -->
            <div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="ph-duotone ph-compass" style="color: #a855f7; font-size: 20px;"></i>
                            å¥‡ä»ªæ’ç›˜æŸ¥è¯¢
                        </h2>
                    </div>
                    
                    <div class="card-body">
                        <!-- åŠŸèƒ½ A: åæŸ¥ç”²ä½ -->
                        <div style="margin-bottom: 32px;">
                            <h3 class="section-subtitle">
                                <span style="display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: #a855f7; margin-right: 8px;"></span>
                                å·²çŸ¥ç”¨ç¥ï¼ŒåæŸ¥ç”²
                            </h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                                <div class="select-wrapper">
                                    <select id="find-jia-gan" class="form-select">
                                        <option value="ä¹™">å¤©å¹²: ä¹™</option><option value="ä¸™">å¤©å¹²: ä¸™</option><option value="ä¸">å¤©å¹²: ä¸</option>
                                        <option value="æˆŠ">å¤©å¹²: æˆŠ</option><option value="å·±">å¤©å¹²: å·±</option><option value="åºš">å¤©å¹²: åºš</option>
                                        <option value="è¾›">å¤©å¹²: è¾›</option><option value="å£¬">å¤©å¹²: å£¬</option><option value="ç™¸">å¤©å¹²: ç™¸</option>
                                    </select>
                                </div>
                                <div class="select-wrapper">
                                    <select id="find-jia-menxing" class="form-select"></select>
                                </div>
                            </div>
                            <button type="button" onclick="findJia()" class="btn btn-query btn-query-purple">
                                æŸ¥è¯¢ç”²ä½
                            </button>
                            <div id="find-jia-result" class="hidden query-result query-result-purple"></div>
                        </div>

                        <div class="divider"></div>

                        <!-- åŠŸèƒ½ B: æ­£æŸ¥ç”¨ç¥ -->
                        <div>
                            <h3 class="section-subtitle">
                                <span style="display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: #ec4899; margin-right: 8px;"></span>
                                å·²çŸ¥ç”²ï¼Œæ­£æŸ¥ç”¨ç¥
                            </h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                                <div class="select-wrapper">
                                    <select id="find-other-jia-menxing" class="form-select"></select>
                                </div>
                                <div class="select-wrapper">
                                    <select id="find-other-gan" class="form-select">
                                        <option value="ä¹™">æ‰¾: ä¹™</option><option value="ä¸™">æ‰¾: ä¸™</option><option value="ä¸">æ‰¾: ä¸</option>
                                        <option value="æˆŠ">æ‰¾: æˆŠ</option><option value="å·±">æ‰¾: å·±</option><option value="åºš">æ‰¾: åºš</option>
                                        <option value="è¾›">æ‰¾: è¾›</option><option value="å£¬">æ‰¾: å£¬</option><option value="ç™¸">æ‰¾: ç™¸</option>
                                    </select>
                                </div>
                            </div>
                            <button type="button" onclick="findOther()" class="btn btn-query btn-query-pink">
                                æŸ¥è¯¢ç”¨ç¥
                            </button>
                            <div id="find-other-result" class="hidden query-result query-result-pink"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰ -->
    <script>
        // --- 1. æ•°æ®ä¸é…ç½® ---
        
        const API_KEY = "629dd8faf6d54b579b0d7b20b63c4f11";
        let pcaData = [];

        const correspondences = {
            "æœé—¨/å¤©è¾…": { "ä¹™": "ä¼‘é—¨/å¤©è“¬", "ä¸™": "ç”Ÿé—¨/å¤©ä»»", "æˆŠ": "ç”Ÿé—¨/å¤©ä»»", "ä¸": "ä¼¤é—¨/å¤©å†²", "å·±": "ä¼¤é—¨/å¤©å†²", "åºš": "å¼€é—¨/å¤©å¿ƒ", "è¾›": "æ™¯é—¨/å¤©è‹±", "å£¬": "æ­»é—¨/å¤©èŠ®", "ç™¸": "æƒŠé—¨/å¤©æŸ±" },
            "æ™¯é—¨/å¤©è‹±": { "ä¹™": "å¼€é—¨/å¤©å¿ƒ", "ä¸™": "ä¼¤é—¨/å¤©å†²", "æˆŠ": "ä¼¤é—¨/å¤©å†²", "ä¸": "ç”Ÿé—¨/å¤©ä»»", "å·±": "ç”Ÿé—¨/å¤©ä»»", "åºš": "ä¼‘é—¨/å¤©è“¬", "è¾›": "æœé—¨/å¤©è¾…", "å£¬": "æƒŠé—¨/å¤©æŸ±", "ç™¸": "æ­»é—¨/å¤©èŠ®" },
            "æ­»é—¨/å¤©èŠ®": { "ä¹™": "æƒŠé—¨/å¤©æŸ±", "ä¸™": "æœé—¨/å¤©è¾…", "æˆŠ": "æœé—¨/å¤©è¾…", "ä¸": "ä¼‘é—¨/å¤©è“¬", "å·±": "ä¼‘é—¨/å¤©è“¬", "åºš": "ç”Ÿé—¨/å¤©ä»»", "è¾›": "ä¼¤é—¨/å¤©å†²", "å£¬": "å¼€é—¨/å¤©å¿ƒ", "ç™¸": "æ™¯é—¨/å¤©è‹±" },
            "ä¼¤é—¨/å¤©å†²": { "ä¹™": "ç”Ÿé—¨/å¤©ä»»", "ä¸™": "ä¼‘é—¨/å¤©è“¬", "æˆŠ": "ä¼‘é—¨/å¤©è“¬", "ä¸": "æœé—¨/å¤©è¾…", "å·±": "æœé—¨/å¤©è¾…", "åºš": "æƒŠé—¨/å¤©æŸ±", "è¾›": "æ­»é—¨/å¤©èŠ®", "å£¬": "æ™¯é—¨/å¤©è‹±", "ç™¸": "å¼€é—¨/å¤©å¿ƒ" },
            "æƒŠé—¨/å¤©æŸ±": { "ä¹™": "æ­»é—¨/å¤©èŠ®", "ä¸™": "æ™¯é—¨/å¤©è‹±", "æˆŠ": "æ™¯é—¨/å¤©è‹±", "ä¸": "å¼€é—¨/å¤©å¿ƒ", "å·±": "å¼€é—¨/å¤©å¿ƒ", "åºš": "ä¼¤é—¨/å¤©å†²", "è¾›": "ç”Ÿé—¨/å¤©ä»»", "å£¬": "ä¼‘é—¨/å¤©è“¬", "ç™¸": "æœé—¨/å¤©è¾…" },
            "ç”Ÿé—¨/å¤©ä»»": { "ä¹™": "ä¼¤é—¨/å¤©å†²", "ä¸™": "å¼€é—¨/å¤©å¿ƒ", "æˆŠ": "å¼€é—¨/å¤©å¿ƒ", "ä¸": "æ™¯é—¨/å¤©è‹±", "å·±": "æ™¯é—¨/å¤©è‹±", "åºš": "æ­»é—¨/å¤©èŠ®", "è¾›": "æƒŠé—¨/å¤©æŸ±", "å£¬": "æœé—¨/å¤©è¾…", "ç™¸": "ä¼‘é—¨/å¤©è“¬" },
            "ä¼‘é—¨/å¤©è“¬": { "ä¹™": "æœé—¨/å¤©è¾…", "ä¸™": "æƒŠé—¨/å¤©æŸ±", "æˆŠ": "æƒŠé—¨/å¤©æŸ±", "ä¸": "æ­»é—¨/å¤©èŠ®", "å·±": "æ­»é—¨/å¤©èŠ®", "åºš": "æ™¯é—¨/å¤©è‹±", "è¾›": "å¼€é—¨/å¤©å¿ƒ", "å£¬": "ä¼¤é—¨/å¤©å†²", "ç™¸": "ç”Ÿé—¨/å¤©ä»»" },
            "å¼€é—¨/å¤©å¿ƒ": { "ä¹™": "æ™¯é—¨/å¤©è‹±", "ä¸™": "æ­»é—¨/å¤©èŠ®", "æˆŠ": "æ­»é—¨/å¤©èŠ®", "ä¸": "æƒŠé—¨/å¤©æŸ±", "å·±": "æƒŠé—¨/å¤©æŸ±", "åºš": "æœé—¨/å¤©è¾…", "è¾›": "ä¼‘é—¨/å¤©è“¬", "å£¬": "ç”Ÿé—¨/å¤©ä»»", "ç™¸": "ä¼¤é—¨/å¤©å†²" }
        };

        // --- 2. API ä¸æ•°æ®è·å– ---
        
        const provinceSelect = document.getElementById('provinceSelect');
        const citySelect = document.getElementById('citySelect');
        const geoStatus = document.getElementById('geo-status');
        const latInput = document.getElementById('lat');
        const lngInput = document.getElementById('lng');
        const dateInput = document.getElementById('date');
        const apiStatusContainer = document.getElementById('api-status-container');
        const apiMsg = document.getElementById('api-msg');
        const apiProgress = document.getElementById('api-progress');
        const twilightBeginInput = document.getElementById('twilightBegin');
        const twilightEndInput = document.getElementById('twilightEnd');

        async function loadPCAData() {
            try {
                geoStatus.textContent = "æ­£åœ¨åŠ è½½åŸå¸‚æ•°æ®...";
                const res = await fetch('https://unpkg.com/china-division/dist/pcas-code.json');
                if(!res.ok) throw new Error("åŸå¸‚æ•°æ®åŠ è½½å¤±è´¥");
                pcaData = await res.json();
                
                provinceSelect.innerHTML = '<option value="">çœä»½</option>';
                pcaData.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.name;
                    opt.text = p.name;
                    provinceSelect.add(opt);
                });
                geoStatus.textContent = "ğŸ‘‡ è¯·é€‰æ‹©åœ°ç‚¹";
            } catch (e) {
                geoStatus.textContent = "âŒ åŸå¸‚æ•°æ®åŠ è½½å¤±è´¥";
                console.error(e);
            }
        }

        function updateCities() {
            const pName = provinceSelect.value;
            citySelect.innerHTML = '<option value="">åŸå¸‚</option>';
            citySelect.disabled = true;

            if(!pName) return;

            const pData = pcaData.find(p => p.name === pName);
            if(pData && pData.children) {
                pData.children.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.name;
                    opt.text = c.name;
                    citySelect.add(opt);
                });
                citySelect.disabled = false;
            }
        }

        let geoTimeout;
        async function fetchCoordinates() {
            const p = provinceSelect.value;
            const c = citySelect.value;

            if(!p) return;

            geoStatus.textContent = "æ­£åœ¨è‡ªåŠ¨å®šä½...";
            geoStatus.className = "status-text";
            geoStatus.style.color = "#3b82f6";
            
            if(!latInput.hasAttribute('readonly')) {
                lockGeoInputs();
            }

            clearTimeout(geoTimeout);
            geoTimeout = setTimeout(async () => {
                try {
                    const searchName = c || p;
                    const omUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(searchName)}&count=5&language=zh&format=json`;
                    
                    let lat, lng, foundName;
                    
                    const res = await fetch(omUrl);
                    const data = await res.json();

                    if(data.results && data.results.length > 0) {
                        const item = data.results.find(i => i.country_code === 'CN') || data.results[0];
                        lat = item.latitude;
                        lng = item.longitude;
                        foundName = item.name;
                    } else {
                        const osmQuery = `ä¸­å›½ ${p} ${c || ''}`;
                        const osmUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(osmQuery)}&format=json&limit=1&addressdetails=1&accept-language=zh-CN`;
                        
                        const res2 = await fetch(osmUrl);
                        if(!res2.ok) throw new Error("Geo Service Unavailable");
                        const data2 = await res2.json();
                        
                        if(data2 && data2.length > 0) {
                            lat = parseFloat(data2[0].lat);
                            lng = parseFloat(data2[0].lon);
                            foundName = data2[0].display_name.split(',')[0];
                        } else {
                            throw new Error("æœªæ‰¾åˆ°ä½ç½®ä¿¡æ¯");
                        }
                    }

                    if(lat && lng) {
                        latInput.value = parseFloat(lat).toFixed(4);
                        lngInput.value = parseFloat(lng).toFixed(4);
                        
                        geoStatus.textContent = `âœ“ å·²å®šä½: ${foundName || (c||p)}`;
                        geoStatus.className = "status-text";
                        geoStatus.style.color = "#10b981";
                        
                        document.getElementById('geo-input-container').classList.add('hidden');
                        fetchSunTimes();
                    }
                } catch (e) {
                    console.error(e);
                    document.getElementById('geo-input-container').classList.remove('hidden');
                    geoStatus.textContent = "âš  è‡ªåŠ¨å®šä½å¤±è´¥";
                    geoStatus.className = "status-text";
                    geoStatus.style.color = "#ef4444";
                    unlockGeoInputs();
                }
            }, 800); 
        }

        function unlockGeoInputs() {
            latInput.removeAttribute('readonly');
            lngInput.removeAttribute('readonly');
            document.getElementById('manualGeoBtn').textContent = "é”å®šåæ ‡";
            document.getElementById('geo-input-container').classList.remove('hidden');
            document.getElementById('geo-tip').classList.remove('hidden');
        }

        function lockGeoInputs() {
            latInput.setAttribute('readonly', true);
            lngInput.setAttribute('readonly', true);
            document.getElementById('manualGeoBtn').textContent = "æŸ¥çœ‹/ä¿®æ”¹ç»çº¬åº¦";
        }

        document.getElementById('manualGeoBtn').addEventListener('click', function() {
            const container = document.getElementById('geo-input-container');
            const tip = document.getElementById('geo-tip');
            
            if(container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                tip.classList.remove('hidden');
                if(latInput.hasAttribute('readonly')) {
                    this.textContent = "ä¿®æ”¹åæ ‡";
                }
            } else {
                if(this.textContent === "ä¿®æ”¹åæ ‡") {
                    unlockGeoInputs();
                } else {
                    container.classList.add('hidden');
                    tip.classList.add('hidden');
                    lockGeoInputs();
                    if(latInput.value && lngInput.value) fetchSunTimes();
                }
            }
        });

        [latInput, lngInput].forEach(input => {
            input.addEventListener('change', () => {
                if(latInput.value && lngInput.value && !latInput.hasAttribute('readonly')) {
                    fetchSunTimes();
                }
            });
        });

        async function fetchSunTimes() {
            const apiKey = API_KEY;
            const dateStr = dateInput.value;
            const lat = latInput.value;
            const lng = lngInput.value;

            if (!lat || !lng || !dateStr) return;

            apiStatusContainer.classList.remove('hidden');
            apiProgress.style.width = '0%';
            apiMsg.textContent = `æ­£åœ¨è·å–å¤©æ–‡æ•°æ®...`;
            apiMsg.className = "api-status-text";
            apiMsg.style.color = "#3b82f6";
            
            setTimeout(() => apiProgress.style.width = '60%', 100);

            try {
                const url = `https://api.ipgeolocation.io/v2/astronomy?apiKey=${apiKey}&lat=${lat}&long=${lng}&date=${dateStr}&time_format=24`;
                
                const response = await fetch(url);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || "è¯·æ±‚å¤±è´¥");
                }

                let morningStart = data.astronomy.morning.civil_twilight_begin;
                let eveningEnd = data.astronomy.evening.civil_twilight_end;

                if (morningStart && morningStart.indexOf(':') > -1) {
                    twilightBeginInput.value = morningStart;
                }
                if (eveningEnd && eveningEnd.indexOf(':') > -1) {
                    twilightEndInput.value = eveningEnd;
                }

                apiProgress.style.width = '100%';
                apiMsg.innerHTML = `<i class="ph-bold ph-check"></i> è·å–æˆåŠŸ`;
                apiMsg.className = "api-status-text";
                apiMsg.style.color = "#10b981";

                setTimeout(() => {
                    apiStatusContainer.classList.add('hidden');
                }, 2000);
                
                calculate();

            } catch (err) {
                apiProgress.style.width = '100%';
                apiMsg.textContent = `é”™è¯¯: ${err.message}`;
                apiMsg.className = "api-status-text";
                apiMsg.style.color = "#ef4444";
                console.error(err);
            }
        }

        // --- 3. æ—¶è¾°è®¡ç®—é€»è¾‘ ---

        const shichenForm = document.getElementById('shichenForm');
        const targetTimeInput = document.getElementById('targetTime');
        const errorBox = document.getElementById('error-box');
        const resultBox = document.getElementById('result-box');
        const shichenNameEl = document.getElementById('shichenName');
        const shichenRangeEl = document.getElementById('shichenRange');
        const toggleDetailsBtn = document.getElementById('toggleDetails');
        const detailsPanel = document.getElementById('details-panel');
        const detailsContent = document.getElementById('details-content');

        function parseTime(t) {
            if (!t) return null;
            const [h, m, s = 0] = t.split(':').map(Number);
            return h * 3600 + m * 60 + s;
        }

        function formatTime(sec) {
            sec = Math.floor(sec);
            let dSec = sec % 86400;
            if (dSec < 0) dSec += 86400;
            const h = Math.floor(dSec / 3600);
            const m = Math.floor((dSec % 3600) / 60);
            const s = dSec % 60;
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        function showError(msg) {
            errorBox.classList.remove('hidden');
            errorBox.querySelector('p').textContent = msg;
            resultBox.classList.add('hidden');
        }

        function calculate() {
            errorBox.classList.add('hidden');
            
            const startStr = twilightBeginInput.value;
            const endStr = twilightEndInput.value;
            const targetStr = targetTimeInput.value;

            if (!startStr || !endStr) {
                showError("è¯·å…ˆè·å–æˆ–è¾“å…¥æ™¨æš®å…‰æ—¶é—´");
                return;
            }
            if (!targetStr) {
                showError("è¯·é€‰æ‹©æŸ¥è¯¢æ—¶é—´");
                return;
            }

            const startSec = parseTime(startStr);
            const endSec = parseTime(endStr);
            const targetSec = parseTime(targetStr);

            if (endSec <= startSec) {
                showError("ç™½æ˜¼ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´");
                return;
            }

            const dayLen = endSec - startSec;
            const nightLen = 86400 - dayLen;
            
            const dayUnit = dayLen / 7;
            const nightUnit = nightLen / 5;

            const dayNames = ['å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰'];
            const nightNames = ['æˆŒ', 'äº¥', 'å­', 'ä¸‘', 'å¯…'];
            
            let intervals = [];
            let curr = startSec;

            dayNames.forEach(name => {
                intervals.push({ name, start: curr, end: curr + dayUnit, type: 'day' });
                curr += dayUnit;
            });

            curr = endSec;
            nightNames.forEach(name => {
                intervals.push({ name, start: curr, end: curr + nightUnit, type: 'night' });
                curr += nightUnit;
            });

            let found = null;
            const tolerance = 0.01;

            for (let iv of intervals) {
                let compTarget = targetSec;
                if (targetSec < startSec) {
                    compTarget += 86400;
                }
                
                if (compTarget >= iv.start - tolerance && compTarget < iv.end - tolerance) {
                    found = iv;
                    break;
                }
            }

            if (found) {
                shichenNameEl.textContent = found.name + 'æ—¶';
                shichenNameEl.className = 'result-title';
                // ä¸éœ€è¦å†…è”é¢œè‰²ï¼ŒCSSå·²å¤„ç†
                
                shichenRangeEl.innerHTML = `
                    <i class="${found.type === 'day' ? 'ph-fill ph-sun' : 'ph-fill ph-moon'}"></i>
                    <span>${formatTime(found.start)} - ${formatTime(found.end)}</span>
                `;

                let html = '';
                intervals.forEach(iv => {
                    let isCurrent = iv.name === found.name;
                    let cls = isCurrent ? 'details-item active' : 'details-item';
                    
                    html += `
                        <div class="${cls}">
                            <span style="font-weight: 600;">${iv.name}æ—¶</span>
                            <span style="opacity: 0.8;">${formatTime(iv.start)} - ${formatTime(iv.end)}</span>
                        </div>
                    `;
                });
                detailsContent.innerHTML = html;
                resultBox.classList.remove('hidden');
            } else {
                showError("æ— æ³•è®¡ç®—æ—¶è¾° (æ—¶é—´è¶…å‡ºèŒƒå›´)");
            }
        }

        shichenForm.addEventListener('submit', (e) => {
            e.preventDefault();
            calculate();
        });

        // --- 4. å¥‡ä»ªé€»è¾‘ ---

        function populateSelects() {
            const opts = Object.keys(correspondences).map(k => `<option value="${k}">${k}</option>`).join('');
            const def1 = '<option value="" disabled selected>é€‰æ‹©é—¨/æ˜Ÿ</option>';
            const def2 = '<option value="" disabled selected>ç”²åœ¨é—¨/æ˜Ÿ</option>';
            document.getElementById('find-jia-menxing').innerHTML = def1 + opts;
            document.getElementById('find-other-jia-menxing').innerHTML = def2 + opts;
        }

        function findJia() {
            const gan = document.getElementById('find-jia-gan').value;
            const mx = document.getElementById('find-jia-menxing').value;
            const resDiv = document.getElementById('find-jia-result');
            
            if (!mx) return;
            resDiv.classList.remove('hidden');
            
            let found = null;
            for(let k in correspondences) {
                if(correspondences[k][gan] === mx) { found = k; break; }
            }

            if(found) {
                resDiv.textContent = `ç”²åœ¨: ${found}`;
                resDiv.className = "query-result query-result-purple";
            } else {
                resDiv.textContent = "æ— åŒ¹é…ç»„åˆ";
                resDiv.className = "query-result";
                resDiv.style.background = "#fee2e2";
                resDiv.style.borderColor = "#fca5a5";
                resDiv.style.color = "#991b1b";
            }
        }

        function findOther() {
            const jiaMx = document.getElementById('find-other-jia-menxing').value;
            const gan = document.getElementById('find-other-gan').value;
            const resDiv = document.getElementById('find-other-result');
            
            if(!jiaMx) return;
            resDiv.classList.remove('hidden');

            const res = correspondences[jiaMx]?.[gan];
            if(res) {
                resDiv.textContent = `${gan} åœ¨: ${res}`;
                resDiv.className = "query-result query-result-pink";
            } else {
                resDiv.textContent = "æŸ¥è¯¢å¤±è´¥";
                resDiv.className = "query-result";
                resDiv.style.background = "#fee2e2";
                resDiv.style.borderColor = "#fca5a5";
                resDiv.style.color = "#991b1b";
            }
        }

        // --- 5. ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ ---
        
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        
        function toggleTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            
            if (isDark) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        // --- åˆå§‹åŒ– ---
        window.onload = async () => {
            initTheme();
            populateSelects();
            
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth()+1).padStart(2,'0');
            const d = String(now.getDate()).padStart(2,'0');
            dateInput.value = `${y}-${m}-${d}`;
            targetTimeInput.value = now.toTimeString().substring(0,8);

            await loadPCAData();

            provinceSelect.addEventListener('change', () => { updateCities(); fetchCoordinates(); });
            citySelect.addEventListener('change', () => { fetchCoordinates(); });
            dateInput.addEventListener('change', fetchSunTimes);

            document.getElementById('toggleManual').addEventListener('click', function() {
                const locked = twilightBeginInput.hasAttribute('readonly');
                if(locked) {
                    twilightBeginInput.removeAttribute('readonly');
                    twilightEndInput.removeAttribute('readonly');
                    this.textContent = "é”å®š";
                } else {
                    twilightBeginInput.setAttribute('readonly', true);
                    twilightEndInput.setAttribute('readonly', true);
                    this.textContent = "è§£é”ç¼–è¾‘";
                }
            });

            document.getElementById('toggleDetails').addEventListener('click', () => {
                detailsPanel.classList.toggle('hidden');
                const icon = toggleDetailsBtn.querySelector('i');
                icon.style.transform = detailsPanel.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
            });
            
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        };
    </script>
</body>
</html>
